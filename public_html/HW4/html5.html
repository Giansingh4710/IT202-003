<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      #canvas {
        width: 600px;
        height: 400px;
        border: 1px solid black;
      }
    </style>
  </head>
  <body>
    <canvas id="canvas" width="600" height="400" tabindex="1"></canvas>
    <button id="start" onclick="main()">Start Game</button>
    <button id="text" onclick="endGame()">end game</button>
  </body>
  <script>
    // Get a reference to the canvas DOM element
    let canvas = document.getElementById("canvas");
    // Get the canvas drawing context
    let context = canvas.getContext("2d");
    // Your score
    let score = 0;
    // Properties for your square
    let x = 250; // X position
    let y = 150; // Y position
    let speed = 6; // Distance to move each frame
    let sideLength = 50; // Length of each side of the square
    // FLags to track which keys are pressed
    let down = false;
    let up = false;
    let right = false;
    let left = false;
    // Properties for the target square
    let targetX = 0;
    let targetY = 0;
    let targetLength = 25;
    // Countdown timer (in seconds)
    let countdown = 30;
    // ID to track the setTimeout
    let id = null;
    let stopAnimationId = null;

    // Determine if number a is within the range b to c (exclusive)
    function isWithin(a, b, c) {
      return a > b && a < c;
    }

    // Listen for keydown events
    canvas.addEventListener("keydown", function (event) {
      event.preventDefault();
      console.log(event.key, event.keyCode);
      if (event.keyCode === 40) {
        // DOWN
        down = true;
      }
      if (event.keyCode === 38) {
        // UP
        up = true;
      }
      if (event.keyCode === 37) {
        // LEFT
        left = true;
      }
      if (event.keyCode === 39) {
        // RIGHT
        right = true;
      }
    });

    // Listen for keyup events
    canvas.addEventListener("keyup", function (event) {
      event.preventDefault();
      console.log(event.key, event.keyCode);
      if (event.keyCode === 40) {
        // DOWN
        down = false;
      }
      if (event.keyCode === 38) {
        // UP
        up = false;
      }
      if (event.keyCode === 37) {
        // LEFT
        left = false;
      }
      if (event.keyCode === 39) {
        // RIGHT
        right = false;
      }
    });

    // Show the start menu
    function intro() {
      context.fillStyle = "#000000";
      context.font = "36px Arial";
      context.textAlign = "center";
      context.fillText(
        "Collect the Square!",
        canvas.width / 2,
        canvas.height / 4
      );
      context.font = "24px Arial";
      context.font = "18px Arial";
      context.fillText(
        "Use the arrow keys to move",
        canvas.width / 2,
        (canvas.height / 4) * 3
      );
    }

    // Start the game
    function startGame() {
      erase();
      // Your score
      score = 0;
      // Properties for your square
      x = 250; // X position
      y = 150; // Y position
      speed = 6; // Distance to move each frame
      sideLength = 50; // Length of each side of the square
      // FLags to track which keys are pressed
      down = false;
      up = false;
      right = false;
      left = false;
      // Properties for the target square
      targetX = 0;
      targetY = 0;
      targetLength = 25;
      // Countdown timer (in seconds)
      countdown = 30;

      // Reduce the countdown timer ever second
      id = setInterval(function () {
        countdown--;
      }, 1000);
      // Stop listening for click events
      // Put the target at a random starting point
      moveTarget();
      // Kick off the draw loop
      draw();
    }

    // Show the game over screen
    function endGame() {
      // Stop the countdown
      clearInterval(id);
      cancelAnimationFrame(stopAnimationId);
      // Display the final score
      erase();
      context.fillStyle = "#000000";
      context.font = "24px Arial";
      context.textAlign = "center";
      context.fillText(
        "Final Score: " + score,
        canvas.width / 2,
        canvas.height / 2
      );
    }

    // Move the target square to a random position
    function moveTarget() {
      targetX = Math.round(Math.random() * canvas.width - targetLength);
      targetY = Math.round(Math.random() * canvas.height - targetLength);
    }

    // Clear the canvas
    function erase() {
      context.fillStyle = "#FFFFFF";
      context.fillRect(0, 0, 600, 400);
    }

    // The main draw loop
    function draw() {
      erase();
      // Move the square
      if (down) {
        y += speed;
      }
      if (up) {
        y -= speed;
      }
      if (right) {
        x += speed;
      }
      if (left) {
        x -= speed;
      }
      // Keep the square within the bounds
      if (y >= canvas.height) {
        y = 0;
      } else if (y + sideLength <= 0) {
        y = canvas.height;
      }

      if (x >= canvas.width) {
        x = 0;
      } else if (x + sideLength <= 0) {
        x = canvas.width;
      }
      // console.log(x, y);
      // Collide with the target
      if (
        isWithin(targetX, x, x + sideLength) ||
        isWithin(targetX + targetLength, x, x + sideLength)
      ) {
        // X
        if (
          isWithin(targetY, y, y + sideLength) ||
          isWithin(targetY + targetLength, y, y + sideLength)
        ) {
          // Y
          // Respawn the target
          moveTarget();
          // Increase the score
          score++;
          sideLength += 5;
        }
      }
      // Draw the square
      context.fillStyle = "#FF0000";
      context.fillRect(x, y, sideLength, sideLength);
      // Draw the target
      context.fillStyle = "#00FF00";
      context.fillRect(targetX, targetY, targetLength, targetLength);
      // Draw the score and time remaining
      context.fillStyle = "#000000";
      context.font = "24px Arial";
      context.textAlign = "left";
      context.fillText("Score: " + score, 10, 24);
      context.fillText("Time Remaining: " + countdown, 10, 50);
      // End the game or keep playing
      if (countdown <= 0) {
        endGame();
      } else {
        stopAnimationId = window.requestAnimationFrame(draw);
      }
    }

    // Start the game
    function main() {
      endGame();
      startGame();
      canvas.focus();
    }
    intro();
  </script>
</html>
